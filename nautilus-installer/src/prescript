if test x$DISPLAY = x; then
   echo "The Nautilus-Installer requires X"
   exit
fi
params="DISPLAY=$DISPLAY"

# Check proxy settings
if test x$http_proxy = x; then
   params="$params"
else
    params="$params http_proxy=$http_proxy"
fi

# Figure out what is already installed
PR1_TO_PR2=no
if [ -f /usr/bin/nautilus ]; then
   VERSION=`/usr/bin/nautilus --version`
   if [ "x$VERSION" = "xGnome nautilus 0.1.0" ]; then
      PR1_TO_PR2=yes
   fi
fi

if test $UID -ne 0 -a "x$1" '!=' "x--version" -a "x$1" '!=' "x--build"; then
   
   # blurp 
   echo ""
   echo "Eazel Installer PR2"
   echo ""
   echo "Eazel Installer requires superuser (root) access to prepare the system"
   echo "and to install packages."
   echo ""
   if [ "x$PR1_TO_PR2" = "xyes" ]; then
      echo "Your PR1 setttings will be moved to ~/.nautilus.pr2.backup..."
      echo ""
   fi
  
   # Start
   echo "Please enter root password at the prompt."
   xhost + localhost
   su - -c "export $params && cd $PWD && echo Uncompressing... && sh $0 $* --user $USER"
   xhost - localhost

   # Move config
   if [ "x$PR1_TO_PR2" = "xyes" ]; then
      VERSION=`/usr/bin/nautilus --version`
      if [ "x$VERSION" != "xGNOME nautilus 0.1.0" ]; then
         echo "Saving old settings..."
         mkdir -p $HOME/.nautilus.pr2.backup >& /dev/null
         mv -f $HOME/.nautilus $HOME/.nautilus.pr2.backup/ >& /dev/null
         mv -f $HOME/Nautilus $HOME/.nautilus.pr2.backup/ >& /dev/null
         mv -f $HOME/.gconf/apps/nautilus/ $HOME/.nautilus.pr2.backup/ >& /dev/null
         mv -f $HOME/.gconf/apps/eazel-trilobite/ $HOME/.nautilus.pr2.backup/ >& /dev/null
      fi
   fi

   exit
fi

